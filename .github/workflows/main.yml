name: Geoverify Logistics CI/CD

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

jobs:
    backend-lint-and-test:
        name: Backend Lint & Test
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend

        steps:
            - uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: "1.22"
                  cache-dependency-path: backend/go.sum

            - name: Install Dependencies
              run: go mod download

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v4
              with:
                  version: v1.58
                  working-directory: backend
                  args: --timeout=5m

            - name: Run Tests
              run: go test -v -cover ./...

            - name: Security Check (govulncheck)
              run: |
                  go install golang.org/x/vuln/cmd/govulncheck@latest
                  govulncheck ./...

    frontend-build-and-lint:
        name: Frontend Build & Lint
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci --legacy-peer-deps

            - name: Run ESLint
              run: npm run lint
              continue-on-error: true # Warning only for now

            - name: Type Check
              run: npx tsc --noEmit

            - name: Build Application
              run: npm run build

            - name: npm audit
              run: npm audit
              continue-on-error: true
